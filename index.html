<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEV Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { --tw-ring-offset-shadow: 0 0 #0000; --tw-ring-shadow: 0 0 #0000; --tw-shadow: 0 0 #0000; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); } 50% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.6); } }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .details-content { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-in-out; }
        .details-content.open { max-height: 5000px; opacity: 1; }
        .arrow-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: inline-block; }
        .arrow-icon.open { transform: rotate(180deg); }
        .card-container { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-container:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.12); }
        .status-badge { font-weight: 600; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; display: inline-flex; align-items: center; gap: 0.25rem; }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .filter-box { transition: all 0.3s ease; border: 2px solid transparent; position: relative; padding-left: 2.5rem; }
        .filter-box:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .filter-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 1.1rem; pointer-events: none; }
        .info-card { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9; }
        .data-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full">
                <div class="flex items-center gap-3 mb-6"><div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl">‚öôÔ∏è</div><h2 class="text-2xl font-bold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2></div>
                <div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">Apps Script URL</label><input type="text" id="urlInput" placeholder="https://script.google.com/macros/s/.../exec" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors bg-gray-50"/></div>
                <div id="settingsError" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded-r-lg"></div>
                <div class="flex gap-3"><button id="saveSettingsBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button id="closeSettingsBtn" class="px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
            </div>
        </div>
        <div class="mb-8">
            <div class="header-gradient rounded-2xl shadow-2xl p-8 text-white"><div class="flex items-start justify-between gap-4 mb-6 flex-wrap"><div><h1 class="text-4xl font-bold mb-2 flex items-center gap-3"><span class="text-5xl">üìä</span> BEV Dashboard Test Product & PM Engineer</h1><p class="text-white text-opacity-90 text-sm hidden"></p></div><div class="flex gap-3 flex-wrap"><a href="https://docs.google.com/spreadsheets/d/1K5532IFh_zpI_ZI7TcDedyYedztRvRMEXcdo3BSBvXA/edit?usp=sharing" target="_blank" class="pulse-glow bg-gradient-to-r from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-3 shadow-2xl transform hover:scale-105 transition-all"><span class="text-2xl">üìú</span><span>‡πÄ‡∏õ‡∏¥‡∏î Google Sheet</span></a><button id="refreshBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2.5 rounded-lg font-semibold flex items-center gap-2 transition-all"><span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button><button id="openSettingsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2.5 rounded-lg font-semibold flex items-center gap-2 transition-all"><span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button></div></div><div class="bg-black bg-opacity-20 rounded-xl p-4 backdrop-blur-sm"><div class="flex items-center justify-between flex-wrap gap-4"><div class="flex items-center gap-3 hidden"><span class="text-2xl">‚è±Ô∏è</span><span class="font-semibold">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</span></div><select id="refreshInterval" class="bg-white text-gray-900 border-0 rounded-lg px-4 py-2 text-sm focus:outline-none font-semibold shadow-lg"><option value="0">‡∏õ‡∏¥‡∏î</option><option value="30" selected>30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option><option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option><option value="120">2 ‡∏ô‡∏≤‡∏ó‡∏µ</option></select></div></div></div>
            <div id="mainError" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm rounded-lg shadow-lg"></div>
        </div>
        <div class="mb-8"><div class="bg-white rounded-2xl shadow-lg p-6"><div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span class="text-2xl">üîç</span> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2><button id="clearFiltersBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold px-4 py-2 rounded-lg hover:bg-indigo-50 transition-all">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"><div class="relative"><span class="filter-icon">üë§</span><select id="customerFilter" class="filter-box w-full px-4 py-3.5 bg-gray-50 text-gray-900 border-2 border-gray-200 rounded-xl focus:outline-none focus:bg-white transition-all font-medium"><option value="">‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option></select></div><div class="relative"><span class="filter-icon">üß™</span><select id="testerFilter" class="filter-box w-full px-4 py-3.5 bg-gray-50 text-gray-900 border-2 border-gray-200 rounded-xl focus:outline-none focus:bg-white transition-all font-medium"><option value="">‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option></select></div><div class="relative"><span class="filter-icon">üíº</span><select id="salespersonFilter" class="filter-box w-full px-4 py-3.5 bg-gray-50 text-gray-900 border-2 border-gray-200 rounded-xl focus:outline-none focus:bg-white transition-all font-medium"><option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option></select></div><div class="relative"><span class="filter-icon">‚úì</span><select id="statusFilter" class="filter-box w-full px-4 py-3.5 bg-gray-50 text-gray-900 border-2 border-gray-200 rounded-xl focus:outline-none focus:bg-white transition-all font-medium"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option><option value="‡∏ú‡πà‡∏≤‡∏ô">‚úì ‡∏ú‡πà‡∏≤‡∏ô</option><option value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô">‚úï ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option><option value="‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö">‚óå ‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option></select></div><div class="relative"><span class="filter-icon">üìÖ</span><select id="monthFilter" class="filter-box w-full px-4 py-3.5 bg-gray-50 text-gray-900 border-2 border-gray-200 rounded-xl focus:outline-none focus:bg-white transition-all font-medium"><option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (PM)</option><option value="‡∏°.‡∏Ñ.">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="‡∏Å.‡∏û.">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="‡∏°‡∏µ.‡∏Ñ.">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option><option value="‡πÄ‡∏°.‡∏¢.">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="‡∏û.‡∏Ñ.">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="‡∏°‡∏¥.‡∏¢.">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option><option value="‡∏Å.‡∏Ñ.">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="‡∏™.‡∏Ñ.">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="‡∏Å.‡∏¢.">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option><option value="‡∏ï.‡∏Ñ.">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="‡∏û.‡∏¢.">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="‡∏ò.‡∏Ñ.">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option></select></div></div><div id="activeFilters" class="hidden mt-4 pt-4 border-t border-gray-200"><div class="flex flex-wrap gap-2" id="activeFiltersList"></div></div></div></div>
        <div id="content" class="space-y-4"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = { scriptUrl: null, autoRefreshTimer: null, allData: [], filters: { customer: '', tester: '', salesperson: '', status: '', month: '' } };
            const elements = { settingsModal: document.getElementById('settingsModal'), urlInput: document.getElementById('urlInput'), saveSettingsBtn: document.getElementById('saveSettingsBtn'), closeSettingsBtn: document.getElementById('closeSettingsBtn'), openSettingsBtn: document.getElementById('openSettingsBtn'), settingsError: document.getElementById('settingsError'), refreshBtn: document.getElementById('refreshBtn'), refreshInterval: document.getElementById('refreshInterval'), mainError: document.getElementById('mainError'), content: document.getElementById('content'), customerFilter: document.getElementById('customerFilter'), testerFilter: document.getElementById('testerFilter'), salespersonFilter: document.getElementById('salespersonFilter'), statusFilter: document.getElementById('statusFilter'), monthFilter: document.getElementById('monthFilter'), clearFiltersBtn: document.getElementById('clearFiltersBtn'), activeFilters: document.getElementById('activeFilters'), activeFiltersList: document.getElementById('activeFiltersList') };

            async function loadData() {
                if (!state.scriptUrl) { openSettings(); return; }
                setLoadingState(true);
                hideError('main');
                elements.content.innerHTML = '<div class="flex justify-center py-16"><div class="spinner"></div></div>';
                try {
                    const response = await fetch(state.scriptUrl + '?cacheBust=' + new Date().getTime());
                    const data = await response.json();
                    if (!data) { throw new Error("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (null)"); }
                    if (data.error) { throw new Error(data.error); }
                    const pmEngineerMap = createPmEngineerMap(data.engi || []);
                    state.allData = groupProductData(data.product || [], pmEngineerMap);
                    populateFilterDropdowns();
                    renderContent();
                } catch (error) { showError('main', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } 
                finally { setLoadingState(false); }
            }
            
            function createPmEngineerMap(rows) { const map = new Map(); if (rows.length < 2) return map; const monthHeaders = rows[0].slice(3, 15); for (let i = 1; i < rows.length; i++) { const row = rows[i].map(c => String(c || '').trim()); const customer = row[0], ci = row[1]; if (customer && ci) { const key = `${customer}_${ci}`; const monthInfos = []; for (let j = 0; j < monthHeaders.length; j++) { if (row[j + 3]) { monthInfos.push(`${row[j + 3]} ${monthHeaders[j]}`); } } map.set(key, { frequency: row[2], month: monthInfos.join(', ') || '-', personInCharge: row[15], salesperson: row[16] }); } } return map; }
            function groupProductData(rows, pmEngineerMap) {
                const groupedData = [];
                let currentGroup = null;
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].map(c => String(c || '').trim());
                    const [workOrder, salesperson, requestDateRaw, customer, ci, solution, device, brand, protocol, features, result, notes, tester, date, modifiedTimeRaw] = row; 
                    if (workOrder) {
                        if (currentGroup) groupedData.push(currentGroup);
                        let formattedTestDate = date ? new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
                        let formattedRequestDate = requestDateRaw ? new Date(requestDateRaw).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
                        currentGroup = { 
                            customer, salesperson, ci, tester, 
                            date: formattedTestDate,
                            requestDate: formattedRequestDate,
                            modifiedTime: formatSheetTime(modifiedTimeRaw),
                            devices: [], statusCount: { passed: 0, failed: 0, pending: 0 }, 
                            pmData: pmEngineerMap.get(`${customer}_${ci}`) || null 
                        };
                    }
                    if ((device || solution || brand) && currentGroup) { 
                        const res = result.toLowerCase();
                        if (res.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.failed++; 
                        else if (res.includes('‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.passed++; 
                        else currentGroup.statusCount.pending++;
                        currentGroup.devices.push({ solution, device, brand, protocol, features, result, notes, date });
                    }
                }
                if (currentGroup) groupedData.push(currentGroup);
                return groupedData;
            }
            function formatSheetTime(dateTimeString) { if (!dateTimeString) return '-'; try { const dateObj = new Date(dateTimeString); if (isNaN(dateObj.getTime())) return dateTimeString; return dateObj.toLocaleString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { return dateTimeString; } }
            function populateFilterDropdowns() { const customers = new Set(); const testers = new Set(); const salespeople = new Set(); state.allData.forEach(group => { if (group.customer) customers.add(group.customer.trim()); if (group.tester) testers.add(group.tester.trim()); if (group.salesperson) salespeople.add(group.salesperson.trim()); }); const sortedCustomers = Array.from(customers).sort((a, b) => a.localeCompare(b, 'th')); elements.customerFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>' + sortedCustomers.map(n => `<option value="${n}">${n}</option>`).join(''); elements.customerFilter.value = state.filters.customer; const sortedTesters = Array.from(testers).sort((a, b) => a.localeCompare(b, 'th')); elements.testerFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option>' + sortedTesters.map(n => `<option value="${n}">${n}</option>`).join(''); elements.testerFilter.value = state.filters.tester; const sortedSalespeople = Array.from(salespeople).sort((a, b) => a.localeCompare(b, 'th')); elements.salespersonFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option>' + sortedSalespeople.map(n => `<option value="${n}">${n}</option>`).join(''); elements.salespersonFilter.value = state.filters.salesperson;}
            function updateActiveFilters() {
                const activeFilterTags = [];
                const filterMap = { customer: { label: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: 'üë§' }, tester: { label: '‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', icon: 'üß™' }, salesperson: { label: '‡πÄ‡∏ã‡∏•‡∏•‡πå', icon: 'üíº' }, status: { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', icon: '‚úì' }, month: { label: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üìÖ' } };
                Object.keys(state.filters).forEach(key => {
                    if (state.filters[key]) {
                        const info = filterMap[key];
                        activeFilterTags.push(`<div class="inline-flex items-center gap-2 bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded-full text-sm font-semibold"><span>${info.icon}</span><span>${info.label}: ${state.filters[key]}</span><button class="ml-1 hover:bg-indigo-200 rounded-full p-0.5" data-clear-filter="${key}">‚úï</button></div>`);
                    }
                });
                if (activeFilterTags.length > 0) { elements.activeFilters.classList.remove('hidden'); elements.activeFiltersList.innerHTML = activeFilterTags.join(''); } 
                else { elements.activeFilters.classList.add('hidden'); }
            }
            function renderContent() { const { customer, tester, salesperson, status, month } = state.filters; let processedData = state.allData.filter(group => (!customer || group.customer === customer) && (!tester || group.tester === tester) && (!salesperson || group.salesperson === salesperson) && (!month || (group.pmData && group.pmData.month && group.pmData.month.includes(month)))); if (status) { processedData = processedData.map(group => ({ ...group, devices: group.devices.filter(device => device.result.includes(status)) })).filter(group => group.devices.length > 0); } updateActiveFilters(); if (processedData.length === 0) { elements.content.innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-16 text-center"><div class="text-6xl mb-4">üîç</div><p class="text-gray-800 text-xl font-bold mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p><p class="text-gray-500 text-sm">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p></div>`; return; } elements.content.innerHTML = processedData.map((g, i) => createGroupCardHTML(g, i)).join(''); }
            
            function createGroupCardHTML(group, index) { 
                const statuses = [{count:group.statusCount.passed,label:'‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úì',color:'bg-emerald-500 text-white shadow-lg shadow-emerald-200'},{count:group.statusCount.failed,label:'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úï',color:'bg-rose-500 text-white shadow-lg shadow-rose-200'},{count:group.statusCount.pending,label:'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö',icon:'‚óå',color:'bg-slate-400 text-white shadow-lg shadow-slate-200'}];
                const sBadges = statuses.filter(s => s.count > 0).map(s => `<div class="status-badge ${s.color}"><span>${s.icon}</span> <strong>${s.count}</strong> ${s.label}</div>`).join('');
                
                const uniqueSolutions = [...new Set(group.devices.map(d => d.solution).filter(Boolean))];
                const solutionBadges = uniqueSolutions.map(s => 
                    `<span class="inline-flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">${s}</span>`
                ).join(' ');
                
                const pmEngineerHTML = group.pmData ? `<div class="mt-6 pt-6 border-t border-gray-200"><h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><span class="text-2xl">üìã</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM Engineer</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.personInCharge || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.salesperson || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.frequency || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</dt><dd class="text-slate-900 font-medium text-sm">${group.pmData.month || '-'}</dd></div></div></div>` : '';
                
                return `
                    <div class="card-container bg-white rounded-2xl shadow-xl border-2 border-gray-100 overflow-hidden hover:border-indigo-200">
                        <div class="p-6 bg-gradient-to-r from-white to-gray-50 cursor-pointer hover:from-indigo-50 hover:to-purple-50 transition-all" data-toggle-index="${index}">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-3 mb-4 flex-wrap">
                                        <h3 class="text-3xl font-bold text-gray-900 flex items-center gap-2"><span class="text-3xl">üè¢</span> ${group.customer}</h3>
                                        <span class="inline-flex items-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">CI: ${group.ci}</span>
                                        ${solutionBadges} </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                        <div class="bg-blue-50 rounded-lg p-3 border-l-4 border-blue-500"><dt class="data-label mb-1">üë®‚Äçüî¨ ‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</dt><dd class="text-gray-900 font-bold">${group.tester || '-'}</dd></div>
                                        <div class="bg-green-50 rounded-lg p-3 border-l-4 border-green-500"><dt class="data-label mb-1">üíº ‡πÄ‡∏ã‡∏•‡∏•‡πå</dt><dd class="text-gray-900 font-bold">${group.salesperson || '-'}</dd></div>
                                        <div class="bg-amber-50 rounded-lg p-3 border-l-4 border-amber-500"><dt class="data-label mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠</dt><dd class="text-gray-900 font-bold">${group.requestDate || '-'}</dd></div>
                                        <div class="bg-rose-50 rounded-lg p-3 border-l-4 border-rose-500"><dt class="data-label mb-1">üïê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</dt><dd class="text-gray-900 font-bold">${group.modifiedTime || '-'}</dd></div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-4 flex-wrap justify-end">
                                    <div class="flex flex-wrap gap-2 justify-end">${sBadges}</div>
                                    <span class="arrow-icon text-indigo-400 text-2xl font-bold">‚ñº</span>
                                </div>
                            </div>
                        </div>
                        <div class="details-content">
                            <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 space-y-4">
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><span class="text-2xl">üîß</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
                                ${group.devices.map(createDeviceRowHTML).join('')}
                                ${pmEngineerHTML}
                            </div>
                        </div>
                    </div>
                `;
            }

            function createDeviceRowHTML(device) { const details=[{label:'üí° ‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡∏ô',value:device.solution},{label:'üè∑Ô∏è ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå/‡∏£‡∏∏‡πà‡∏ô',value:device.brand},{label:'üîå ‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•',value:device.protocol},{label:'‚öôÔ∏è ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå',value:device.features},{label:'üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',value:device.notes},{label:'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö',value:formatDeviceDate(device.date)}];const dhtml=details.map(d=>d.value?`<dt class="data-label">${d.label}</dt><dd class="text-gray-800 col-span-2 font-medium">${d.value}</dd>`:'').join('');return`<div class="border-l-4 ${getStatusBorderColor(device.result)} pl-5 py-4 bg-white rounded-r-xl shadow-md hover:shadow-lg transition-all"><div class="flex items-start justify-between mb-4 gap-3 flex-wrap"><h4 class="font-bold text-xl text-gray-900 flex items-center gap-2"><span class="text-2xl">üì±</span> ${device.device||'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}</h4><span class="px-4 py-2 rounded-xl text-sm font-bold shadow-lg ${getStatusColorClass(device.result)}">${device.result||'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö'}</span></div>${dhtml?`<div class="grid grid-cols-3 gap-x-4 gap-y-3 text-sm">${dhtml}</div>`:''}</div>`;}
            function formatDeviceDate(dateString) { if (!dateString) return '-'; try { return new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { return dateString; } }
            function getStatusColorClass(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'bg-gradient-to-r from-rose-500 to-red-600 text-white';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'bg-gradient-to-r from-emerald-500 to-green-600 text-white';return'bg-gradient-to-r from-slate-400 to-gray-500 text-white';}
            function getStatusBorderColor(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'border-rose-500';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'border-emerald-500';return'border-slate-400';}
            function openSettings() { elements.urlInput.value = state.scriptUrl || ''; elements.settingsModal.classList.remove('hidden'); }
            function closeSettings() { elements.settingsModal.classList.add('hidden'); }
            function saveSettings() { const u = elements.urlInput.value.trim(); if (!u) { showError('settings', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL'); return; } if (!u.endsWith('/exec')) { showError('settings', 'URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; } state.scriptUrl = u; localStorage.setItem('scriptUrl', u); closeSettings(); loadData(); updateAutoRefresh(); }
            function updateAutoRefresh() { const s = parseInt(elements.refreshInterval.value, 10); localStorage.setItem('refreshInterval', s); if (state.autoRefreshTimer) clearInterval(state.autoRefreshTimer); if (s > 0) state.autoRefreshTimer = setInterval(loadData, s * 1000); }
            function getInitialUrl() { const p = new URLSearchParams(window.location.search); let u = p.get('url'); const a = p.get('api'); if (!u && a) u = `https://script.google.com/macros/s/${a}/exec`; if (u) localStorage.setItem('scriptUrl', u); return localStorage.getItem('scriptUrl'); }
            function setLoadingState(L) { elements.refreshBtn.disabled = L; elements.refreshBtn.querySelector('span').innerHTML = L ? '‚è≥' : 'üîÑ'; }
            function showError(t, m) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.innerHTML = m.replace(/\n/g, '<br>'); e.classList.remove('hidden'); }
            function hideError(t) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.classList.add('hidden'); }
            
            function clearAllFilters() {
                state.filters = { customer: '', tester: '', salesperson: '', status: '', month: '' };
                elements.customerFilter.value = '';
                elements.testerFilter.value = '';
                elements.salespersonFilter.value = '';
                elements.statusFilter.value = '';
                elements.monthFilter.value = '';
                renderContent();
            }

            function setupEventListeners() {
                elements.openSettingsBtn.addEventListener('click', openSettings);
                elements.closeSettingsBtn.addEventListener('click', closeSettings);
                elements.saveSettingsBtn.addEventListener('click', saveSettings);
                elements.refreshBtn.addEventListener('click', loadData);
                elements.refreshInterval.addEventListener('change', updateAutoRefresh);
                elements.clearFiltersBtn.addEventListener('click', clearAllFilters);
                elements.customerFilter.addEventListener('change', e => { state.filters.customer = e.target.value; renderContent(); });
                elements.testerFilter.addEventListener('change', e => { state.filters.tester = e.target.value; renderContent(); });
                elements.salespersonFilter.addEventListener('change', e => { state.filters.salesperson = e.target.value; renderContent(); });
                elements.statusFilter.addEventListener('change', e => { state.filters.status = e.target.value; renderContent(); });
                elements.monthFilter.addEventListener('change', e => { state.filters.month = e.target.value; renderContent(); });
                elements.content.addEventListener('click', e => { const h = e.target.closest('[data-toggle-index]'); if (h) { const d = h.nextElementSibling; const a = h.querySelector('.arrow-icon'); d.classList.toggle('open'); a.classList.toggle('open'); } });
                elements.activeFiltersList.addEventListener('click', e => {
                    const clearBtn = e.target.closest('[data-clear-filter]');
                    if (clearBtn) {
                        const filterKey = clearBtn.dataset.clearFilter;
                        state.filters[filterKey] = '';
                        elements[filterKey + 'Filter'].value = '';
                        renderContent();
                    }
                });
            }
            function initializeApp() { setupEventListeners(); elements.refreshInterval.value = localStorage.getItem('refreshInterval') || '30'; state.scriptUrl = getInitialUrl(); if (state.scriptUrl) { loadData(); updateAutoRefresh(); } else { openSettings(); } }
            try { initializeApp(); } 
            catch (e) { console.error("Critical error:", e); if (elements.content) elements.content.innerHTML = `<div class="p-6 bg-rose-100 border-l-4 border-rose-500 text-rose-700 rounded-lg"><h3 class="font-bold text-lg mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${e.message}</p></div>`; }
        });
    </script>
</body>
</html>