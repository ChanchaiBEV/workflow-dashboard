<script type="module">
    // =============================================
    // üî• FIREBASE v12 IMPORTS
    // =============================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
    import {
        getAuth,
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy,
        limit,
        onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    
    // =============================================
    // üî• FIREBASE v12 CONFIG (‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤)
    // =============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCaH8Yuz4NTJ18woedPFhf1jL5UqSHxJqs",
        authDomain: "bev-dashboard-chat.firebaseapp.com",
        projectId: "bev-dashboard-chat",
        storageBucket: "bev-dashboard-chat.firebasestorage.app",
        messagingSenderId: "1013753938979",
        appId: "1:1013753938979:web:fc4bb84095822de8631d96",
        measurementId: "G-QHPY9MP0Z4"
    };

    // Initialize Firebase
    const fbApp = initializeApp(firebaseConfig);
    const fbAnalytics = getAnalytics(fbApp);
    const fbAuth = getAuth(fbApp);
    const fbStore = getFirestore(fbApp);
    const googleProvider = new GoogleAuthProvider();

    // ======== üéµ 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞ "‡∏ò‡∏á" ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ========
    const notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');
    notificationSound.preload = 'auto';
    let isAudioUnlocked = false; // <-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞


    // =============================================
    // üöÄ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ (Dashboard + Chat)
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
        let state = { scriptUrl: null, autoRefreshTimer: null, allData: [], filters: { customer: '', tester: '', salesperson: '', status: '', month: '' } };
        const elements = { settingsModal: document.getElementById('settingsModal'), urlInput: document.getElementById('urlInput'), saveSettingsBtn: document.getElementById('saveSettingsBtn'), closeSettingsBtn: document.getElementById('closeSettingsBtn'), openSettingsBtn: document.getElementById('openSettingsBtn'), settingsError: document.getElementById('settingsError'), refreshBtn: document.getElementById('refreshBtn'), refreshInterval: document.getElementById('refreshInterval'), mainError: document.getElementById('mainError'), content: document.getElementById('content'), customerFilter: document.getElementById('customerFilter'), testerFilter: document.getElementById('testerFilter'), salespersonFilter: document.getElementById('salespersonFilter'), statusFilter: document.getElementById('statusFilter'), monthFilter: document.getElementById('monthFilter'), clearFiltersBtn: document.getElementById('clearFiltersBtn'), activeFilters: document.getElementById('activeFilters'), activeFiltersList: document.getElementById('activeFiltersList') };

        // =============================================
        // üî• ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á FIREBASE CHAT
        // =============================================
        let currentUser = null;
        let unsubscribeMessages = null; 

        const chatWidget = document.getElementById('chatWidget');
        const chatHeader = document.getElementById('chatHeader');
        const chatToggle = document.getElementById('chatToggle');
        const chatContainer = document.getElementById('chatContainer');
        const chatSignIn = document.getElementById('chatSignIn');
        const chatLoginBtn = document.getElementById('chatLoginBtn');
        const chatMain = document.getElementById('chatMain');
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        
        chatWidget.classList.remove('hidden'); 

        // ======== üéµ 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö Global ========
        function unlockAudio() {
            if (isAudioUnlocked) return; // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å

            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
                isAudioUnlocked = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤ "‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"
                console.log("Audio context unlocked by user interaction.");
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏•‡∏ö Liseners ‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û)
                document.body.removeEventListener('click', unlockAudio);
                document.body.removeEventListener('keydown', unlockAudio);
            }).catch(e => {
                // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏ü‡∏• ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πá‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            });
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å"
        document.body.addEventListener('click', unlockAudio);
        document.body.addEventListener('keydown', unlockAudio);


        // ======== üéµ 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° Login ========
        chatLoginBtn.addEventListener('click', () => {
            // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà Global Listeners ‡πÅ‡∏•‡πâ‡∏ß)
            signInWithPopup(fbAuth, googleProvider).catch(error => {
                console.error("Login failed:", error);
            });
        });

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (text && currentUser) {
                try {
                    await addDoc(collection(fbStore, 'messages'), {
                        text: text,
                        name: currentUser.displayName || currentUser.email,
                        email: currentUser.email,
                        uid: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    chatInput.value = ''; 
                } catch (err) {
                    console.error("Error sending message:", err);
                }
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        onAuthStateChanged(fbAuth, user => {
            if (user) {
                currentUser = user;
                chatSignIn.classList.add('hidden');
                chatMain.classList.remove('hidden');
                listenToMessages();
            } else {
                currentUser = null;
                chatSignIn.classList.remove('hidden');
                chatMain.classList.add('hidden');
                if (unsubscribeMessages) unsubscribeMessages();
                chatMessages.innerHTML = ''; 
            }
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á/‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        function listenToMessages() {
            if (unsubscribeMessages) unsubscribeMessages();

            let isInitialLoad = true;

            const messagesQuery = query(
                collection(fbStore, 'messages'),
                orderBy('createdAt', 'desc'),
                limit(50)
            );

            unsubscribeMessages = onSnapshot(messagesQuery, snapshot => {
                
                if (isInitialLoad) {
                    chatMessages.innerHTML = '';
                }

                snapshot.docChanges().reverse().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        
                        renderMessage(data); 

                        // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ isAudioUnlocked ‡πÄ‡∏õ‡πá‡∏ô true ‡πÅ‡∏•‡πâ‡∏ß
                        if (!isInitialLoad && currentUser && data.uid !== currentUser.uid) {
                            notificationSound.play().catch(e => {
                                console.log("Audio play failed (maybe unlock first):", e.message);
                            });
                        }
                    }
                });
                
                isInitialLoad = false;

            }, error => console.error("Error listening to messages:", error));
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        function renderMessage(data) {
            if (!currentUser) return;
            const isMine = data.uid === currentUser.uid;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMine ? 'mine' : 'theirs'}`;
            
            let senderName = isMine ? '‡∏Ñ‡∏∏‡∏ì' : (data.name || data.email.split('@')[0]);
            
            const senderDiv = document.createElement('div');
            senderDiv.className = 'chat-bubble-sender';
            senderDiv.textContent = senderName;

            const textDiv = document.createElement('div');
            textDiv.textContent = data.text;

            bubble.appendChild(senderDiv);
            bubble.appendChild(textDiv);
            
            chatMessages.appendChild(bubble); 
            
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏±‡∏ö/‡∏Å‡∏≤‡∏á‡πÅ‡∏ä‡∏ó (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        chatHeader.addEventListener('click', () => {
            chatContainer.classList.toggle('hidden');
            chatToggle.textContent = chatContainer.classList.contains('hidden') ? '‚ñ≤' : '‚ñº';
        });
        
        // =============================================
        // üî• ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á FIREBASE CHAT END
        // =============================================


        //
        // --- ‡πÇ‡∏Ñ‡πâ‡∏î DASHBOARD ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
        //
        async function loadData() {
            if (!state.scriptUrl) { openSettings(); return; }
            setLoadingState(true);
            hideError('main');
            elements.content.innerHTML = '<div class="flex justify-center py-16"><div class="spinner"></div></div>';
            try {
                const response = await fetch(state.scriptUrl + '?cacheBust=' + new Date().getTime());
                const data = await response.json();
                if (!data) { throw new Error("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (null)"); }
                if (data.error) { throw new Error(data.error); }
                const pmEngineerMap = createPmEngineerMap(data.engi || []);
                state.allData = groupProductData(data.product || [], pmEngineerMap);
                populateFilterDropdowns();
                renderContent();
            } catch (error) { showError('main', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } 
            finally { setLoadingState(false); }
        }
        
        function createPmEngineerMap(rows) { const map = new Map(); if (rows.length < 2) return map; const monthHeaders = rows[0].slice(3, 15); for (let i = 1; i < rows.length; i++) { const row = rows[i].map(c => String(c || '').trim()); const customer = row[0], ci = row[1]; if (customer && ci) { const key = `${customer}_${ci}`; const monthInfos = []; for (let j = 0; j < monthHeaders.length; j++) { if (row[j + 3]) { monthInfos.push(`${row[j + 3]} ${monthHeaders[j]}`); } } map.set(key, { frequency: row[2], month: monthInfos.join(', ') || '-', personInCharge: row[15], salesperson: row[16] }); } } return map; }
        function groupProductData(rows, pmEngineerMap) {
            const groupedData = [];
            let currentGroup = null;
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].map(c => String(c || '').trim());
                const [workOrder, salesperson, requestDateRaw, customer, ci, solution, device, brand, protocol, features, result, notes, tester, date, modifiedTimeRaw] = row; 
                if (workOrder) {
                    if (currentGroup) groupedData.push(currentGroup);
                    let formattedTestDate = date ? new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
                    let formattedRequestDate = requestDateRaw ? new Date(requestDateRaw).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
                    currentGroup = { 
                        customer, salesperson, ci, tester, 
                        date: formattedTestDate,
                        requestDate: formattedRequestDate,
                        modifiedTime: formatSheetTime(modifiedTimeRaw),
                        devices: [], statusCount: { passed: 0, failed: 0, pending: 0 }, 
                        pmData: pmEngineerMap.get(`${customer}_${ci}`) || null 
                    };
                }
                if ((device || solution || brand) && currentGroup) { 
                    const res = result.toLowerCase();
                    if (res.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.failed++; 
                    else if (res.includes('‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.passed++; 
                    else currentGroup.statusCount.pending++;
                    currentGroup.devices.push({ solution, device, brand, protocol, features, result, notes, date });
                }
            }
            if (currentGroup) groupedData.push(currentGroup);
            return groupedData;
        }
        function formatSheetTime(dateTimeString) { if (!dateTimeString) return '-'; try { const dateObj = new Date(dateTimeString); if (isNaN(dateObj.getTime())) return dateTimeString; return dateObj.toLocaleString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { return dateTimeString; } }
        function populateFilterDropdowns() { const customers = new Set(); const testers = new Set(); const salespeople = new Set(); state.allData.forEach(group => { if (group.customer) customers.add(group.customer.trim()); if (group.tester) testers.add(group.tester.trim()); if (group.salesperson) salespeople.add(group.salesperson.trim()); }); const sortedCustomers = Array.from(customers).sort((a, b) => a.localeCompare(b, 'th')); elements.customerFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>' + sortedCustomers.map(n => `<option value="${n}">${n}</option>`).join(''); elements.customerFilter.value = state.filters.customer; const sortedTesters = Array.from(testers).sort((a, b) => a.localeCompare(b, 'th')); elements.testerFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option>' + sortedTesters.map(n => `<option value="${n}">${n}</option>`).join(''); elements.testerFilter.value = state.filters.tester; const sortedSalespeople = Array.from(salespeople).sort((a, b) => a.localeCompare(b, 'th')); elements.salespersonFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option>' + sortedSalespeople.map(n => `<option value="${n}">${n}</option>`).join(''); elements.salespersonFilter.value = state.filters.salesperson;}
        function updateActiveFilters() {
            const activeFilterTags = [];
            const filterMap = { customer: { label: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: 'üë§' }, tester: { label: '‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', icon: 'üß™' }, salesperson: { label: '‡πÄ‡∏ã‡∏•‡∏•‡πå', icon: 'üíº' }, status: { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', icon: '‚úì' }, month: { label: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üìÖ' } };
            Object.keys(state.filters).forEach(key => {
                if (state.filters[key]) {
                    const info = filterMap[key];
                    activeFilterTags.push(`<div class="inline-flex items-center gap-2 bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded-full text-sm font-semibold"><span>${info.icon}</span><span>${info.label}: ${state.filters[key]}</span><button class="ml-1 hover:bg-indigo-200 rounded-full p-0.5" data-clear-filter="${key}">‚úï</button></div>`);
                }
            });
            if (activeFilterTags.length > 0) { elements.activeFilters.classList.remove('hidden'); elements.activeFiltersList.innerHTML = activeFilterTags.join(''); } 
            else { elements.activeFilters.classList.add('hidden'); }
        }
        function renderContent() { const { customer, tester, salesperson, status, month } = state.filters; let processedData = state.allData.filter(group => (!customer || group.customer === customer) && (!tester || group.tester === tester) && (!salesperson || group.salesperson === salesperson) && (!month || (group.pmData && group.pmData.month && group.pmData.month.includes(month)))); if (status) { processedData = processedData.map(group => ({ ...group, devices: group.devices.filter(device => device.result.includes(status)) })).filter(group => group.devices.length > 0); } updateActiveFilters(); if (processedData.length === 0) { elements.content.innerHTML = `<div class="bg-white rounded-2xl shadow-lg p-16 text-center"><div class="text-6xl mb-4">üîç</div><p class="text-gray-800 text-xl font-bold mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p><p class="text-gray-500 text-sm">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p></div>`; return; } elements.content.innerHTML = processedData.map((g, i) => createGroupCardHTML(g, i)).join(''); }
        
        function createGroupCardHTML(group, index) { 
            const statuses = [{count:group.statusCount.passed,label:'‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úì',color:'bg-emerald-500 text-white shadow-lg shadow-emerald-200'},{count:group.statusCount.failed,label:'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úï',color:'bg-rose-500 text-white shadow-lg shadow-rose-200'},{count:group.statusCount.pending,label:'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö',icon:'‚óå',color:'bg-slate-400 text-white shadow-lg shadow-slate-200'}];
            const sBadges = statuses.filter(s => s.count > 0).map(s => `<div class="status-badge ${s.color}"><span>${s.icon}</span> <strong>${s.count}</strong> ${s.label}</div>`).join('');
            
            const uniqueSolutions = [...new Set(group.devices.map(d => d.solution).filter(Boolean))];
            const solutionBadges = uniqueSolutions.map(s => 
                `<span class="inline-flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">${s}</span>`
            ).join(' ');
            
            const pmEngineerHTML = group.pmData ? `<div class="mt-6 pt-6 border-t border-gray-200"><h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><span class="text-2xl">üìã</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM Engineer</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.personInCharge || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.salesperson || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</dt><dd class="text-gray-900 font-bold text-lg">${group.pmData.frequency || '-'}</dd></div><div class="info-card rounded-xl p-4 shadow-md"><dt class="data-label mb-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</dt><dd class="text-slate-900 font-medium text-sm">${group.pmData.month || '-'}</dd></div></div></div>` : '';
            
            return `
                <div class="card-container bg-white rounded-2xl shadow-xl border-2 border-gray-100 overflow-hidden hover:border-indigo-200">
                    <div class="p-6 bg-gradient-to-r from-white to-gray-50 cursor-pointer hover:from-indigo-50 hover:to-purple-50 transition-all" data-toggle-index="${index}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-4 flex-wrap">
                                    <h3 class="text-3xl font-bold text-gray-900 flex items-center gap-2"><span class="text-3xl">üè¢</span> ${group.customer}</h3>
                                    <span class="inline-flex items-center gap-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg">CI: ${group.ci}</span>
                                    ${solutionBadges} </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                    <div class="bg-blue-50 rounded-lg p-3 border-l-4 border-blue-500"><dt class="data-label mb-1">üë®‚Äçüî¨ ‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</dt><dd class="text-gray-900 font-bold">${group.tester || '-'}</dd></div>
                                    <div class="bg-green-50 rounded-lg p-3 border-l-4 border-green-500"><dt class="data-label mb-1">üíº ‡πÄ‡∏ã‡∏•‡∏•‡πå</dt><dd class="text-gray-900 font-bold">${group.salesperson || '-'}</dd></div>
                                    <div class="bg-amber-50 rounded-lg p-3 border-l-4 border-amber-500"><dt class="data-label mb-1">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠</dt><dd class="text-gray-900 font-bold">${group.requestDate || '-'}</dd></div>
                                    <div class="bg-rose-50 rounded-lg p-3 border-l-4 border-rose-500"><dt class="data-label mb-1">üïê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</dt><dd class="text-gray-900 font-bold">${group.modifiedTime || '-'}</dd></div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-4 flex-wrap justify-end">
                                <div class="flex flex-wrap gap-2 justify-end">${sBadges}</div>
                                <span class="arrow-icon text-indigo-400 text-2xl font-bold">‚ñº</span>
                            </div>
                        </div>
                    </div>
                    <div class="details-content">
                        <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 space-y-4">
                            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg"><span class="text-2xl">üîß</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
                            ${group.devices.map(createDeviceRowHTML).join('')}
                            ${pmEngineerHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function createDeviceRowHTML(device) { const details=[{label:'üí° ‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡∏ô',value:device.solution},{label:'üè∑Ô∏è ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå/‡∏£‡∏∏‡πà‡∏ô',value:device.brand},{label:'üîå ‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•',value:device.protocol},{label:'‚öôÔ∏è ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå',value:device.features},{label:'üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',value:device.notes},{label:'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö',value:formatDeviceDate(device.date)}];const dhtml=details.map(d=>d.value?`<dt class="data-label">${d.label}</dt><dd class="text-gray-800 col-span-2 font-medium">${d.value}</dd>`:'').join('');return`<div class="border-l-4 ${getStatusBorderColor(device.result)} pl-5 py-4 bg-white rounded-r-xl shadow-md hover:shadow-lg transition-all"><div class="flex items-start justify-between mb-4 gap-3 flex-wrap"><h4 class="font-bold text-xl text-gray-900 flex items-center gap-2"><span class="text-2xl">üì±</span> ${device.device||'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}</h4><span class="px-4 py-2 rounded-xl text-sm font-bold shadow-lg ${getStatusColorClass(device.result)}">${device.result||'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö'}</span></div>${dhtml?`<div class="grid grid-cols-3 gap-x-4 gap-y-3 text-sm">${dhtml}</div>`:''}</div>`;}
        function formatDeviceDate(dateString) { if (!dateString) return '-'; try { return new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { return dateString; } }
        function getStatusColorClass(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'bg-gradient-to-r from-rose-500 to-red-600 text-white';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'bg-gradient-to-r from-emerald-500 to-green-600 text-white';return'bg-gradient-to-r from-slate-400 to-gray-500 text-white';}
        function getStatusBorderColor(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'border-rose-500';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'border-emerald-500';return'border-slate-400';}
        function openSettings() { elements.urlInput.value = state.scriptUrl || ''; elements.settingsModal.classList.remove('hidden'); }
        function closeSettings() { elements.settingsModal.classList.add('hidden'); }
        function saveSettings() { const u = elements.urlInput.value.trim(); if (!u) { showError('settings', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL'); return; } if (!u.endsWith('/exec')) { showError('settings', 'URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; } state.scriptUrl = u; localStorage.setItem('scriptUrl', u); closeSettings(); loadData(); updateAutoRefresh(); }
        function updateAutoRefresh() { const s = parseInt(elements.refreshInterval.value, 10); localStorage.setItem('refreshInterval', s); if (state.autoRefreshTimer) clearInterval(state.autoRefreshTimer); if (s > 0) state.autoRefreshTimer = setInterval(loadData, s * 1000); }
        function getInitialUrl() { const p = new URLSearchParams(window.location.search); let u = p.get('url'); const a = p.get('api'); if (!u && a) u = `https://script.google.com/macros/s/${a}/exec`; if (u) localStorage.setItem('scriptUrl', u); return localStorage.getItem('scriptUrl'); }
        function setLoadingState(L) { elements.refreshBtn.disabled = L; elements.refreshBtn.querySelector('span').innerHTML = L ? '‚è≥' : 'üîÑ'; }
        function showError(t, m) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.innerHTML = m.replace(/\n/g, '<br>'); e.classList.remove('hidden'); }
        function hideError(t) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.classList.add('hidden'); }
        
        function clearAllFilters() {
            state.filters = { customer: '', tester: '', salesperson: '', status: '', month: '' };
            elements.customerFilter.value = '';
            elements.testerFilter.value = '';
            elements.salespersonFilter.value = '';
            elements.statusFilter.value = '';
            elements.monthFilter.value = '';
            renderContent();
        }

        function setupEventListeners() {
            elements.openSettingsBtn.addEventListener('click', openSettings);
            elements.closeSettingsBtn.addEventListener('click', closeSettings);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            elements.refreshBtn.addEventListener('click', loadData);
            elements.refreshInterval.addEventListener('change', updateAutoRefresh);
            elements.clearFiltersBtn.addEventListener('click', clearAllFilters);
            elements.customerFilter.addEventListener('change', e => { state.filters.customer = e.target.value; renderContent(); });
            elements.testerFilter.addEventListener('change', e => { state.filters.tester = e.target.value; renderContent(); });
            elements.salespersonFilter.addEventListener('change', e => { state.filters.salesperson = e.target.value; renderContent(); });
            elements.statusFilter.addEventListener('change', e => { state.filters.status = e.target.value; renderContent(); });
            elements.monthFilter.addEventListener('change', e => { state.filters.month = e.target.value; renderContent(); });
            elements.content.addEventListener('click', e => { const h = e.target.closest('[data-toggle-index]'); if (h) { const d = h.nextElementSibling; const a = h.querySelector('.arrow-icon'); d.classList.toggle('open'); a.classList.toggle('open'); } });
            elements.activeFiltersList.addEventListener('click', e => {
                const clearBtn = e.target.closest('[data-clear-filter]');
                if (clearBtn) {
                    const filterKey = clearBtn.dataset.clearFilter;
                    state.filters[filterKey] = '';
                    elements[filterKey + 'Filter'].value = '';
                    renderContent();
                }
            });
        }
        function initializeApp() { setupEventListeners(); elements.refreshInterval.value = localStorage.getItem('refreshInterval') || '30'; state.scriptUrl = getInitialUrl(); if (state.scriptUrl) { loadData(); updateAutoRefresh(); } else { openSettings(); } }
        try { initializeApp(); } 
        catch (e) { console.error("Critical error:", e); if (elements.content) elements.content.innerHTML = `<div class="p-6 bg-rose-100 border-l-4 border-rose-500 text-rose-700 rounded-lg"><h3 class="font-bold text-lg mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${e.message}</p></div>`; }
        // --- ‡πÇ‡∏Ñ‡πâ‡∏î DASHBOARD ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì END ---
    });
</script>