<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Workflow Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { --tw-ring-offset-shadow: 0 0 #0000; --tw-ring-shadow: 0 0 #0000; --tw-shadow: 0 0 #0000; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .details-content { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-in-out; }
        .details-content.open { max-height: 5000px; opacity: 1; }
        .arrow-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: inline-block; }
        .arrow-icon.open { transform: rotate(180deg); }
        .card-container { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-container:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
        .pulse-indicator { animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-badge { font-weight: 600; font-size: 0.75rem; padding: 0.375rem 0.75rem; border-radius: 9999px; display: inline-flex; align-items: center; gap: 0.25rem; }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .filter-box { transition: all 0.3s ease; border: 2px solid transparent; }
        .filter-box:focus { border-color: #667eea; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full"><div class="flex items-center gap-3 mb-6"><div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl">‚öôÔ∏è</div><h2 class="text-2xl font-bold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2></div><div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">Apps Script URL</label><input type="text" id="urlInput" placeholder="https://script.google.com/macros/s/.../exec" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors bg-gray-50"/></div><div id="settingsError" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded-r-lg"></div><div class="flex gap-3"><button id="saveSettingsBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button id="closeSettingsBtn" class="px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div>
        </div>
        <div class="mb-8">
            <div class="header-gradient rounded-2xl shadow-lg p-8 text-white"><div class="flex items-start justify-between gap-4 mb-6 flex-wrap"><h1 class="text-4xl font-bold">üìä Test Workflow</h1><div class="flex gap-2 flex-wrap"><button id="refreshBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2.5 text-sm rounded-lg font-semibold flex items-center gap-2"><span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button><button id="openSettingsBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2.5 text-sm rounded-lg font-semibold flex items-center gap-2"><span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button></div></div><div class="flex items-center justify-between flex-wrap gap-4 bg-black bg-opacity-20 rounded-lg p-4"><div class="flex items-center gap-2"><span class="w-2 h-2 bg-green-400 rounded-full pulse-indicator"></span><p id="lastUpdate" class="text-sm text-blue-100 hidden"></p></div><div class="flex items-center gap-3 bg-white rounded-lg px-3 py-2"><label class="text-sm font-medium text-gray-900">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:</label><select id="refreshInterval" class="bg-white text-gray-900 border-0 rounded-lg text-sm focus:outline-none font-semibold"><option value="0">‡∏õ‡∏¥‡∏î</option><option value="30" selected>30 ‡∏ß‡∏¥</option><option value="60">60 ‡∏ß‡∏¥</option><option value="120">2 ‡∏ô‡∏≤‡∏ó‡∏µ</option></select></div></div></div>
            <div id="mainError" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 text-sm rounded-lg"></div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            <select id="customerFilter" class="filter-box w-full px-4 py-3.5 bg-white text-gray-900 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-all">
                <option value="">-- ‡∏ó‡∏∏‡∏Å‚Äã‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>
            </select>
            <select id="testerFilter" class="filter-box w-full px-4 py-3.5 bg-white text-gray-900 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-all">
                <option value="">-- ‡∏ó‡∏∏‡∏Å‚Äã‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö --</option>
            </select>
            <select id="salespersonFilter" class="filter-box w-full px-4 py-3.5 bg-white text-gray-900 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-all">
                <option value="">-- ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>
            </select>
            <select id="statusFilter" class="filter-box w-full px-4 py-3.5 bg-white text-gray-900 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-all">
                <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                <option value="‡∏ú‡πà‡∏≤‡∏ô">‚úì ‡∏ú‡πà‡∏≤‡∏ô</option>
                <option value="‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô">‚úï ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
                <option value="‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö">‚óå ‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option>
            </select>
            <select id="monthFilter" class="filter-box w-full px-4 py-3.5 bg-white text-gray-900 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-all">
                <option value="">-- ‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (PM) --</option>
                <option value="‡∏°.‡∏Ñ.">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="‡∏Å.‡∏û.">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="‡∏°‡∏µ.‡∏Ñ.">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                <option value="‡πÄ‡∏°.‡∏¢.">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="‡∏û.‡∏Ñ.">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="‡∏°‡∏¥.‡∏¢.">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                <option value="‡∏Å.‡∏Ñ.">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="‡∏™.‡∏Ñ.">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="‡∏Å.‡∏¢.">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                <option value="‡∏ï.‡∏Ñ.">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="‡∏û.‡∏¢.">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="‡∏ò.‡∏Ñ.">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
            </select>
        </div>

        <div id="content" class="space-y-4"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = { scriptUrl: null, autoRefreshTimer: null, allData: [], filters: { customer: '', tester: '', salesperson: '', status: '', month: '' } };
            const elements = { settingsModal: document.getElementById('settingsModal'), urlInput: document.getElementById('urlInput'), saveSettingsBtn: document.getElementById('saveSettingsBtn'), closeSettingsBtn: document.getElementById('closeSettingsBtn'), openSettingsBtn: document.getElementById('openSettingsBtn'), settingsError: document.getElementById('settingsError'), refreshBtn: document.getElementById('refreshBtn'), lastUpdate: document.getElementById('lastUpdate'), refreshInterval: document.getElementById('refreshInterval'), mainError: document.getElementById('mainError'), content: document.getElementById('content'), customerFilter: document.getElementById('customerFilter'), testerFilter: document.getElementById('testerFilter'), salespersonFilter: document.getElementById('salespersonFilter'), statusFilter: document.getElementById('statusFilter'), monthFilter: document.getElementById('monthFilter') };

            async function loadData() {
                if (!state.scriptUrl) { openSettings(); return; }
                setLoadingState(true);
                hideError('main');
                elements.content.innerHTML = '<div class="flex justify-center py-16"><div class="spinner"></div></div>';
                try {
                    const response = await fetch(state.scriptUrl + '?cacheBust=' + new Date().getTime());
                    const data = await response.json();
                    if (data.error) { throw new Error(data.error); }
                    const pmEngineerMap = createPmEngineerMap(data.engi || []);
                    state.allData = groupProductData(data.product || [], pmEngineerMap);
                    populateFilterDropdowns();
                    renderContent();
                    updateLastUpdateTime();
                } catch (error) { showError('main', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`); } 
                finally { setLoadingState(false); }
            }
            
            function createPmEngineerMap(rows) { const map = new Map(); if (rows.length < 2) return map; const monthHeaders = rows[0].slice(3, 15); for (let i = 1; i < rows.length; i++) { const row = rows[i].map(c => String(c || '').trim()); const customer = row[0], ci = row[1]; if (customer && ci) { const key = `${customer}_${ci}`; const monthInfos = []; for (let j = 0; j < monthHeaders.length; j++) { if (row[j + 3]) { monthInfos.push(`${row[j + 3]} ${monthHeaders[j]}`); } } map.set(key, { frequency: row[2], month: monthInfos.join(', ') || '-', personInCharge: row[15], salesperson: row[16] }); } } return map; }
            function groupProductData(rows, pmEngineerMap) { const groupedData = []; let currentGroup = null; for (let i = 1; i < rows.length; i++) { const row = rows[i].map(c => String(c || '').trim()); const [workOrder, salesperson, customer, ci, solution, device, brand, protocol, features, result, notes, tester, date, rowId] = row; if (workOrder) { if (currentGroup) groupedData.push(currentGroup); let formattedDate = date ? new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'; currentGroup = { customer, salesperson, ci, tester, date: formattedDate, devices: [], statusCount: { passed: 0, failed: 0, pending: 0 }, pmData: pmEngineerMap.get(`${customer}_${ci}`) || null }; } if ((device || solution || brand) && currentGroup) { const res = result.toLowerCase(); if (res.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.failed++; else if (res.includes('‡∏ú‡πà‡∏≤‡∏ô')) currentGroup.statusCount.passed++; else currentGroup.statusCount.pending++; currentGroup.devices.push({ solution, device, brand, protocol, features, result, notes }); } } if (currentGroup) groupedData.push(currentGroup); return groupedData; }
            
            function populateFilterDropdowns() {
                const customers = new Set();
                const testers = new Set();
                const salespeople = new Set();

                state.allData.forEach(group => {
                    if (group.customer) customers.add(group.customer.trim());
                    if (group.tester) testers.add(group.tester.trim());
                    if (group.salesperson) salespeople.add(group.salesperson.trim());
                });

                const sortedCustomers = Array.from(customers).sort((a, b) => a.localeCompare(b, 'th'));
                elements.customerFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‚Äã‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>' + sortedCustomers.map(n => `<option value="${n}">${n}</option>`).join('');
                elements.customerFilter.value = state.filters.customer;

                const sortedTesters = Array.from(testers).sort((a, b) => a.localeCompare(b, 'th'));
                elements.testerFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‚Äã‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö --</option>' + sortedTesters.map(n => `<option value="${n}">${n}</option>`).join('');
                elements.testerFilter.value = state.filters.tester;

                const sortedSalespeople = Array.from(salespeople).sort((a, b) => a.localeCompare(b, 'th'));
                elements.salespersonFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>' + sortedSalespeople.map(n => `<option value="${n}">${n}</option>`).join('');
                elements.salespersonFilter.value = state.filters.salesperson;
            }
            
            function renderContent() {
                const { customer, tester, salesperson, status, month } = state.filters;
                
                let processedData = state.allData
                    .filter(group => 
                        (!customer || group.customer === customer) &&
                        (!tester || group.tester === tester) &&
                        (!salesperson || group.salesperson === salesperson) &&
                        (!month || (group.pmData && group.pmData.month && group.pmData.month.includes(month)))
                    );

                if (status) {
                    processedData = processedData.map(group => ({ ...group, devices: group.devices.filter(device => device.result.includes(status)) })).filter(group => group.devices.length > 0);
                }

                if (processedData.length === 0) {
                    elements.content.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-16 text-center"><div class="text-4xl mb-4">üîç</div><p class="text-gray-600 text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p><p class="text-gray-500 text-sm mt-2">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p></div>';
                    return;
                }
                elements.content.innerHTML = processedData.map((g, i) => createGroupCardHTML(g, i)).join('');
            }
            
            function createGroupCardHTML(group, index) { 
                const statuses=[{count:group.statusCount.passed,label:'‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úì',color:'bg-emerald-100 text-emerald-700'},{count:group.statusCount.failed,label:'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô',icon:'‚úï',color:'bg-rose-100 text-rose-700'},{count:group.statusCount.pending,label:'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö',icon:'‚óå',color:'bg-slate-100 text-slate-700'}];
                const sBadges=statuses.filter(s=>s.count>0).map(s=>`<div class="status-badge ${s.color}"><span>${s.icon}</span> ${s.count} ${s.label}</div>`).join('');
                const mSolution=group.devices.length>0?group.devices[0].solution:'';
                const pmEngineerHTML=group.pmData?`<div class="mt-6 pt-6 border-t border-gray-200"><h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM Engineer</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm"><div class="bg-slate-50 rounded-lg p-3 border border-slate-200"><dt class="text-xs font-semibold text-slate-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</dt><dd class="text-slate-900 font-medium">${group.pmData.frequency||'-'}</dd></div><div class="bg-slate-50 rounded-lg p-3 border border-slate-200"><dt class="text-xs font-semibold text-slate-600 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</dt><dd class="text-slate-900 font-medium">${group.pmData.month||'-'}</dd></div><div class="bg-slate-50 rounded-lg p-3 border border-slate-200"><dt class="text-xs font-semibold text-slate-600 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</dt><dd class="text-slate-900 font-medium">${group.pmData.personInCharge||'-'}</dd></div><div class="bg-slate-50 rounded-lg p-3 border border-slate-200"><dt class="text-xs font-semibold text-slate-600 mb-1">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</dt><dd class="text-slate-900 font-medium">${group.pmData.salesperson||'-'}</dd></div></div></div>`:'';
                
                return `
                    <div class="card-container bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="p-6 bg-white cursor-pointer hover:bg-gray-50 transition-colors" data-toggle-index="${index}">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-3 mb-4 flex-wrap">
                                        <h3 class="text-2xl font-bold text-gray-800">${group.customer}</h3>
                                        <span class="inline-flex items-center gap-2 bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full text-sm font-semibold">CI: ${group.ci}</span>
                                        ${mSolution ? `<span class="inline-flex items-center gap-2 bg-cyan-100 text-cyan-700 px-3 py-1.5 rounded-full text-sm font-semibold">${mSolution}</span>` : ''}
                                    </div>
                                    <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-800 mt-3">
                                        <span><strong class="font-bold text-indigo-600">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</strong> ${group.tester || '-'}</span>
                                        <span><strong class="font-bold text-indigo-600">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•:</strong> ${group.salesperson || '-'}</span>
                                        <span><strong class="font-bold text-indigo-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</strong> ${group.date || '-'}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-4 flex-wrap justify-end">
                                    <div class="badge-group justify-end">${sBadges}</div>
                                    <span class="arrow-icon text-gray-400 ml-4 text-xl">‚ñº</span>
                                </div>
                            </div>
                        </div>
                        <div class="details-content">
                            <div class="px-6 py-4 border-t border-gray-200 space-y-4">
                                ${group.devices.map(createDeviceRowHTML).join('')}
                                ${pmEngineerHTML}
                            </div>
                        </div>
                    </div>
                `;
            }

            function createDeviceRowHTML(device) { const details=[{label:'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',value:device.device},{label:'‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå/‡∏£‡∏∏‡πà‡∏ô',value:device.brand},{label:'‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•/‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',value:device.protocol},{label:'‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö',value:device.features},{label:'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',value:device.notes}];const dhtml=details.map(d=>d.value?`<dt class="font-semibold text-gray-500 text-sm">${d.label}</dt><dd class="text-gray-700 col-span-2">${d.value}</dd>`:'').join('');return`<div class="border-l-4 ${getStatusBorderColor(device.result)} pl-4 py-4 bg-slate-50 rounded-r-lg"><div class="flex items-start justify-between mb-3 gap-3 flex-wrap"><h4 class="font-semibold text-base text-gray-800">${device.solution||device.device||'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}</h4><span class="px-3 py-1.5 rounded-lg text-xs font-bold ${getStatusColorClass(device.result)}">${device.result||'‡∏£‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö'}</span></div>${dhtml?`<div class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm">${dhtml}</div>`:''}</div>`;}
            function getStatusColorClass(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'bg-rose-500 text-white';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'bg-emerald-500 text-white';return'bg-slate-500 text-white';}
            function getStatusBorderColor(s) { s=(s||'').toLowerCase();if(s.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'))return'border-rose-500';if(s.includes('‡∏ú‡πà‡∏≤‡∏ô'))return'border-emerald-500';return'border-slate-500';}
            function openSettings() { elements.urlInput.value = state.scriptUrl || ''; elements.settingsModal.classList.remove('hidden'); }
            function closeSettings() { elements.settingsModal.classList.add('hidden'); }
            function saveSettings() { const u = elements.urlInput.value.trim(); if (!u) { showError('settings', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL'); return; } if (!u.endsWith('/exec')) { showError('settings', 'URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; } state.scriptUrl = u; localStorage.setItem('scriptUrl', u); closeSettings(); loadData(); updateAutoRefresh(); }
            function updateAutoRefresh() { const s = parseInt(elements.refreshInterval.value, 10); localStorage.setItem('refreshInterval', s); if (state.autoRefreshTimer) clearInterval(state.autoRefreshTimer); if (s > 0) state.autoRefreshTimer = setInterval(loadData, s * 1000); updateLastUpdateTime(); }
            function getInitialUrl() { const p = new URLSearchParams(window.location.search); let u = p.get('url'); const a = p.get('api'); if (!u && a) u = `https://script.google.com/macros/s/${a}/exec`; if (u) localStorage.setItem('scriptUrl', u); return localStorage.getItem('scriptUrl'); }
            function updateLastUpdateTime() { elements.lastUpdate.classList.remove('hidden'); const t = new Date().toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit' }); const i = elements.refreshInterval.value; let r = '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏õ‡∏¥‡∏î'; if (i > 0) r = `‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å ${i} ‡∏ß‡∏¥`; elements.lastUpdate.innerHTML = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span class="font-semibold">${t}</span> ‚Ä¢ ${r}`; }
            function setLoadingState(L) { elements.refreshBtn.disabled = L; elements.refreshBtn.querySelector('span').innerHTML = L ? '‚è≥' : 'üîÑ'; }
            function showError(t, m) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.innerHTML = m.replace(/\n/g, '<br>'); e.classList.remove('hidden'); }
            function hideError(t) { const e = t === 'main' ? elements.mainError : elements.settingsError; e.classList.add('hidden'); }

            function setupEventListeners() {
                elements.openSettingsBtn.addEventListener('click', openSettings);
                elements.closeSettingsBtn.addEventListener('click', closeSettings);
                elements.saveSettingsBtn.addEventListener('click', saveSettings);
                elements.refreshBtn.addEventListener('click', loadData);
                elements.refreshInterval.addEventListener('change', updateAutoRefresh);
                elements.customerFilter.addEventListener('change', e => { state.filters.customer = e.target.value; renderContent(); });
                elements.testerFilter.addEventListener('change', e => { state.filters.tester = e.target.value; renderContent(); });
                elements.salespersonFilter.addEventListener('change', e => { state.filters.salesperson = e.target.value; renderContent(); });
                elements.statusFilter.addEventListener('change', e => { state.filters.status = e.target.value; renderContent(); });
                elements.monthFilter.addEventListener('change', e => { state.filters.month = e.target.value; renderContent(); });
                elements.content.addEventListener('click', e => { const h = e.target.closest('[data-toggle-index]'); if (h) { const d = h.nextElementSibling; const a = h.querySelector('.arrow-icon'); d.classList.toggle('open'); a.classList.toggle('open'); } });
            }

            function initializeApp() { setupEventListeners(); elements.refreshInterval.value = localStorage.getItem('refreshInterval') || '30'; state.scriptUrl = getInitialUrl(); if (state.scriptUrl) { loadData(); updateAutoRefresh(); } else { openSettings(); } }
            try { initializeApp(); } 
            catch (e) { console.error("Critical error:", e); if (elements.content) elements.content.innerHTML = `<div class="p-6 bg-rose-100 border-l-4 border-rose-500 text-rose-700 rounded-lg"><h3 class="font-bold text-lg mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p>${e.message}</p></div>`; }
        });
    </script>
</body>
</html>